<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESE | Global Index</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
</head>

<body>

    <div class="nav-header">
        <a href="about.html" class="nav-link">ABOUT</a>
        <a href="search.html" class="nav-icon">üîç</a>
    </div>

    <div class="container">
        <h1>ESE</h1>
        <div style="font-size: 1.2rem; color: #666; letter-spacing: 0.2em; margin-top: -20px; margin-bottom: 60px;">THE
            Evolvimus Search Engine</div>

        <div style="margin-bottom: 40px;">
            <div id="pageCounter" style="font-size: 4rem; font-weight: 900; color: #fff; line-height: 1;">0</div>
            <div
                style="color: var(--accent); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.2em; margin-top: 10px;">
                Indexed Pages</div>
        </div>

        <div class="submission-container">
            <input type="text" id="urlInput" placeholder="https://your-site.com">
            <!-- Category is now AI-Detected automatically -->
            <button class="action-btn" onclick="submitUrl()">Index Now</button>
            <div id="status" style="margin-top: 20px; color: #888; font-size: 0.9rem; min-height: 20px;"></div>

            <!-- Live Terminal -->
            <div id="terminal" class="terminal-window" style="display: none;">
                <div class="terminal-header">
                    <span style="color: #555;">root@ese-node-1:~# crawl --deep --ai</span>
                </div>
                <div id="terminal-content" class="terminal-body"></div>
            </div>
        </div>
    </div>

    <!-- Server Locations Footer -->
    <div class="server-ticker">
        <div class="ticker-content">
            <div class="server-loc">Tokio <div class="status-dot"></div>
            </div>
            <div class="server-loc">New York <div class="status-dot"></div>
            </div>
            <div class="server-loc">Silicon Valley <div class="status-dot"></div>
            </div>
            <div class="server-loc">Frankfurt <div class="status-dot"></div>
            </div>
            <div class="server-loc">Oslo <div class="status-dot"></div>
            </div>
            <div class="server-loc">N√ºrnberg <div class="status-dot"></div>
            </div>
            <div class="server-loc">Berlin <div class="status-dot"></div>
            </div>
            <div class="server-loc">M√ºnchen <div class="status-dot"></div>
            </div>
            <div class="server-loc">London <div class="status-dot"></div>
            </div>
            <div class="server-loc">Wien <div class="status-dot"></div>
            </div>
            <div class="server-loc">Amsterdam <div class="status-dot"></div>
            </div>

            <!-- Active Node -->
            <div class="server-loc active">Coburg <div class="status-dot"></div>
            </div>
        </div>
    </div>

    <script>
        // Stats
        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                document.getElementById('pageCounter').innerText = data.total_pages.toLocaleString();
            } catch (e) { }
        }
        setInterval(loadStats, 2000);
        loadStats();

        // Terminal Logic
        let evtSource = null;

        function initTerminal() {
            const term = document.getElementById('terminal');
            const termBody = document.getElementById('terminal-content');
            term.style.display = 'block';

            if (evtSource) return;

            evtSource = new EventSource('/api/stream');

            evtSource.onmessage = function (e) {
                const data = JSON.parse(e.data);
                const line = document.createElement('div');
                line.style.marginBottom = '4px';
                line.style.fontFamily = 'monospace';

                // Colors
                if (data.type === 'ai') line.style.color = '#bf00ff'; // Neon Purple for AI
                else if (data.type === 'ai_success') line.style.color = '#d455ff';
                else if (data.type === 'crawl') line.style.color = '#00ff88'; // Green
                else if (data.type === 'save') line.style.color = '#fff';
                else if (data.type === 'error') line.style.color = '#ff4444';
                else line.style.color = '#888';

                const time = data.timestamp.split('T')[1].split('.')[0];
                line.innerText = `[${time}] ${data.message}`;

                termBody.appendChild(line);
                termBody.scrollTop = termBody.scrollHeight; // Auto scroll
            };
        }

        async function submitUrl() {
            const url = document.getElementById('urlInput').value;
            const statusEl = document.getElementById('status');

            if (!url) return;

            // Start Terminal immediately
            initTerminal();
            statusEl.innerText = "Initializing connection...";

            try {
                const res = await fetch('/api/submit', {
                    method: 'POST',
                    body: JSON.stringify({ url, category: 'auto' })
                });
                const data = await res.json();
                if (data.status === 'queued') {
                    statusEl.innerText = "Job Queued. Watch terminal below.";
                    document.getElementById('urlInput').value = "";
                } else {
                    statusEl.innerText = "Signal Lost: " + data.error;
                }
            } catch (e) {
                statusEl.innerText = "Connection Failed.";
            }
        }
    </script>
</body>

</html>